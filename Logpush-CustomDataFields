# ============================
# HARD-CODED VARIABLES
# ============================

$ZoneId     = "YOUR_ZONE_ID_HERE"
$ApiToken   = "YOUR_API_TOKEN_HERE"
$ConfigPath = ".\cf-logpush-custom-fields.json"

# ============================
# DO NOT EDIT BELOW
# ============================

$baseUrl = "https://api.cloudflare.com/client/v4/zones/$ZoneId"
$headers = @{
    Authorization = "Bearer $ApiToken"
    "Content-Type" = "application/json"
}

# Read config file (PowerShell 5.1 compatible)
if (-not (Test-Path $ConfigPath)) {
    throw "Config file not found: $ConfigPath"
}

$config = (Get-Content $ConfigPath) -join "`n" | ConvertFrom-Json

$actionParameters = @{}

if ($config.request_headers -and $config.request_headers.Count -gt 0) {
    $actionParameters.request_fields = $config.request_headers |
        ForEach-Object { @{ name = $_.ToLower() } }
}

if ($config.response_headers -and $config.response_headers.Count -gt 0) {
    $actionParameters.response_fields = $config.response_headers |
        ForEach-Object { @{ name = $_.ToLower() } }
}

if ($config.cookies -and $config.cookies.Count -gt 0) {
    $actionParameters.cookie_fields = $config.cookies |
        ForEach-Object { @{ name = $_ } }
}

if ($actionParameters.Count -eq 0) {
    throw "No custom fields defined in $ConfigPath"
}

Write-Host "==> Request headers : $($config.request_headers -join ', ')"
Write-Host "==> Response headers: $($config.response_headers -join ', ')"
Write-Host "==> Cookies         : $($config.cookies -join ', ')"

# Get existing ruleset for http_log_custom_fields
$rulesets = Invoke-RestMethod -Method GET -Uri "$baseUrl/rulesets" -Headers $headers

$ruleset = $rulesets.result |
    Where-Object { $_.kind -eq "zone" -and $_.phase -eq "http_log_custom_fields" } |
    Select-Object -First 1

# Create ruleset if missing
if (-not $ruleset) {
    Write-Host "==> No http_log_custom_fields ruleset found. Creating one..."

    $createBody = @{
        name        = "Zone-level phase entry point"
        kind        = "zone"
        phase       = "http_log_custom_fields"
        description = "Logpush Custom Fields"
    } | ConvertTo-Json

    $createResult = Invoke-RestMethod -Method POST -Uri "$baseUrl/rulesets" -Headers $headers -Body $createBody
    $ruleset = $createResult.result
}

# IMPORTANT: use a separate variable (fixes the 'variable reference is not valid' issue)
$rulesetId = $ruleset.id
Write-Host "==> Using ruleset ID: $rulesetId"

# Build ruleset update payload
$body = @{
    rules = @(
        @{
            action            = "log_custom_field"
            expression        = "true"
            enabled           = $true
            description       = "Set Logpush custom fields"
            action_parameters = $actionParameters
        }
    )
} | ConvertTo-Json -Depth 10

# Update ruleset – note the use of $rulesetId (no property access inside the string)
$result = Invoke-RestMethod -Method PUT `
    -Uri "$baseUrl/rulesets/$rulesetId" `
    -Headers $headers `
    -Body $body

Write-Host "✅ Logpush custom fields updated"

if ($result.result -and $result.result.rules -and $result.result.rules.Count -gt 0) {
    $result.result.rules[0].action_parameters | ConvertTo-Json -Depth 10
}
