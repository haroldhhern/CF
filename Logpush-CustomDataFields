# ============================
# HARD-CODED VARIABLES
# ============================

$ZoneId     = "YOUR_ZONE_ID_HERE"
$ApiToken   = "YOUR_API_TOKEN_HERE"
$ConfigPath = ".\cf-logpush-custom-fields.json"

# ============================
# DO NOT EDIT BELOW
# ============================

$baseUrl = "https://api.cloudflare.com/client/v4/zones/$ZoneId"
$headers = @{
    Authorization = "Bearer $ApiToken"
    "Content-Type" = "application/json"
}

# Read config file (PowerShell 5.1 compatible)
$config = (Get-Content $ConfigPath) -join "`n" | ConvertFrom-Json

$actionParameters = @{}

if ($config.request_headers -and $config.request_headers.Count -gt 0) {
    $actionParameters.request_fields = $config.request_headers |
        ForEach-Object { @{ name = $_.ToLower() } }
}

if ($config.response_headers -and $config.response_headers.Count -gt 0) {
    $actionParameters.response_fields = $config.response_headers |
        ForEach-Object { @{ name = $_.ToLower() } }
}

if ($config.cookies -and $config.cookies.Count -gt 0) {
    $actionParameters.cookie_fields = $config.cookies |
        ForEach-Object { @{ name = $_ } }
}

if ($actionParameters.Count -eq 0) {
    throw "No custom fields defined in $ConfigPath"
}

# Get existing ruleset for http_log_custom_fields
$rulesets = Invoke-RestMethod -Method GET -Uri "$baseUrl/rulesets" -Headers $headers

$ruleset = $rulesets.result |
    Where-Object { $_.kind -eq "zone" -and $_.phase -eq "http_log_custom_fields" } |
    Select-Object -First 1

# Create ruleset if missing
if (-not $ruleset) {
    $createBody = @{
        name        = "Zone-level phase entry point"
        kind        = "zone"
        phase       = "http_log_custom_fields"
        description = "Logpush Custom Fields"
    } | ConvertTo-Json

    $createResult = Invoke-RestMethod -Method POST -Uri "$baseUrl/rulesets" -Headers $headers -Body $createBody
    $ruleset = $createResult.result
}

$rulesetId = $ruleset.id

# Build ruleset update payload
$body = @{
    rules = @(
        @{
            action            = "log_custom_field"
            expression        = "true"
            enabled           = $true
            description       = "Set Logpush custom fields"
            action_parameters = $actionParameters
        }
    )
} | ConvertTo-Json -Depth 10

# Update ruleset
$result = Invoke-RestMethod -Method PUT `
    -Uri "$baseUrl/rulesets/$rulesetId" `
    -Headers $headers `
    -Body $body

Write-Host "âœ… Logpush custom fields updated"
