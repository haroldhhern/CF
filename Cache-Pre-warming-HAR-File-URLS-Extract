<#
    HAR → Static URLs → Pre-warm Cloudflare cache (host-agnostic)

    Behavior:
      - If assets.txt exists, script asks if you want to reuse it.
      - If you reuse it → skips extraction and begins pre-warming.
      - If not → extracts URLs again from HAR, overwrites assets.txt, then pre-warms.

    Note:
      - On Windows PowerShell 5.x, -UseBasicParsing avoids IE/cookie prompts.
      - On PowerShell 7+, remove -UseBasicParsing (it’s not needed and will error).
#>

# -------------------------
# CONFIG
# -------------------------
$HarPath     = "capture.har"      # Path to your HAR file
$OutputFile  = "assets.txt"       # File to store extracted static URLs
$UserAgent   = "Cache-Prewarm-Bot/1.0"

# Static file extensions to treat as pre-warm candidates
$StaticExtensions = @(
    ".js", ".css", ".png", ".jpg", ".jpeg",
    ".gif", ".svg", ".webp", ".ico",
    ".woff", ".woff2", ".ttf", ".otf"
)

# Optional: Exclude hosts (leave empty for fully host-agnostic)
$ExcludedHosts = @(
    # "fonts.googleapis.com",
    # "www.googletagmanager.com"
)

# -------------------------
# FUNCTION: Extract URLs from HAR
# -------------------------
function Get-StaticUrlsFromHar {
    param(
        [string]$HarFilePath,
        [string[]]$StaticExts,
        [string[]]$ExcludedHosts
    )

    Write-Host "Loading HAR file: $HarFilePath"

    if (!(Test-Path $HarFilePath)) {
        throw "HAR file not found at path: $HarFilePath"
    }

    try {
        $harJson = Get-Content $HarFilePath -Raw | ConvertFrom-Json
    }
    catch {
        throw "Failed to parse HAR JSON: $($_.Exception.Message)"
    }

    if (-not $harJson.log.entries) {
        throw "No entries found in HAR. Is this a valid HAR export?"
    }

    Write-Host "Extracting static asset URLs..."

    $urls = $harJson.log.entries |
        Where-Object { $_.request.method -eq "GET" } |
        ForEach-Object {
            try { [Uri]$_.request.url } catch { $null }
        } |
        Where-Object { $_ -ne $null } |
        Where-Object {
            if ($ExcludedHosts.Count -eq 0) { $true }
            else { -not ($ExcludedHosts -contains $_.Host) }
        } |
        Where-Object {
            $ext = [System.IO.Path]::GetExtension($_.AbsolutePath).ToLower()
            $StaticExts -contains $ext
        } |
        ForEach-Object {
            # Keep full URL, including query string
            $_.AbsoluteUri
        } |
        Sort-Object -Unique

    Write-Host "Found $($urls.Count) static asset URLs."

    return $urls
}

# -------------------------
# MAIN LOGIC
# -------------------------
$urls = @()

if (Test-Path $OutputFile) {
    Write-Host "URL list '$OutputFile' already exists."
    $choice = Read-Host "Do you want to reuse this list? (Y/N)"

    if ($choice -match '^[Yy]') {
        Write-Host "Reusing existing URL list."
        $urls = Get-Content $OutputFile
    }
    else {
        Write-Host "Re-extracting URLs from HAR..."
        try {
            $urls = Get-StaticUrlsFromHar -HarFilePath $HarPath -StaticExts $StaticExtensions -ExcludedHosts $ExcludedHosts
        }
        catch {
            Write-Host "ERROR: $($_.Exception.Message)"
            return
        }

        if ($urls.Count -eq 0) {
            Write-Host "No static URLs found — nothing to warm."
            return
        }

        $urls | Set-Content -Encoding UTF8 $OutputFile
        Write-Host "Saved new URL list to $OutputFile"
    }
}
else {
    Write-Host "No existing URL list found. Extracting from HAR..."
    try {
        $urls = Get-StaticUrlsFromHar -HarFilePath $HarPath -StaticExts $StaticExtensions -ExcludedHosts $ExcludedHosts
    }
    catch {
        Write-Host "ERROR: $($_.Exception.Message)"
        return
    }

    if ($urls.Count -eq 0) {
        Write-Host "No static URLs found — nothing to warm."
        return
    }

    $urls | Set-Content -Encoding UTF8 $OutputFile
    Write-Host "Saved new URL list to $OutputFile"
}

# ---------------
