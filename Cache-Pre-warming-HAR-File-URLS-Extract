<#
    HAR → Static URLs → Pre-warm Cloudflare cache (host-agnostic)

    Behavior:
      - If assets.txt exists, script asks if you want to reuse it.
      - If you reuse it → skips HAR parsing and begins pre-warming.
      - If not → extracts URLs again from HAR, overwrites assets.txt, then pre-warms.

    Notes:
      - On Windows PowerShell 5.x, we use -UseBasicParsing to avoid IE/cookie prompts.
      - On PowerShell 7+, -UseBasicParsing is NOT used (it doesn't exist there).
#>

# -------------------------
# CONFIG
# -------------------------
$HarPath     = "capture.har"      # Path to your HAR file
$OutputFile  = "assets.txt"       # File to store extracted static URLs
$UserAgent   = "Cache-Prewarm-Bot/1.0"

# Static file extensions to treat as pre-warm candidates
$StaticExtensions = @(
    ".js", ".css", ".png", ".jpg", ".jpeg",
    ".gif", ".svg", ".webp", ".ico",
    ".woff", ".woff2", ".ttf", ".otf"
)

# Optional: Exclude hosts (leave empty for fully host-agnostic)
$ExcludedHosts = @(
    # "fonts.googleapis.com",
    # "www.googletagmanager.com"
)

# Detect if we should use -UseBasicParsing (only valid on Windows PowerShell 5.x)
$IsWindowsPowerShell5 = ($PSVersionTable.PSVersion.Major -lt 6)

# -------------------------
# FUNCTION: Extract URLs from HAR
# -------------------------
function Get-StaticUrlsFromHar {
    param(
        [string]$HarFilePath,
        [string[]]$StaticExts,
        [string[]]$ExcludedHosts
    )

    Write-Host "Loading HAR file: $HarFilePath"

    if (!(Test-Path $HarFilePath)) {
        throw "HAR file not found at path: $HarFilePath"
    }

    try {
        $harJson = Get-Content $HarFilePath -Raw | ConvertFrom-Json
    }
    catch {
        throw "Failed to parse HAR JSON: $($_.Exception.Message)"
    }

    if (-not $harJson.log.entries) {
        throw "No entries found in HAR. Is this a valid HAR export?"
    }

    Write-Host "Extracting static asset URLs..."

    $urls = $harJson.log.entries |
        Where-Object { $_.request.method -eq "GET" } |
        ForEach-Object {
            try { [Uri]$_.request.url } catch { $null }
        } |
        Where-Object { $_ -ne $null } |
        Where-Object {
            if ($ExcludedHosts.Count -eq 0) { $true }
            else { -not ($ExcludedHosts -contains $_.Host) }
        } |
        Where-Object {
            $ext = [System.IO.Path]::GetExtension($_.AbsolutePath).ToLower()
            $StaticExts -contains $ext
        } |
        ForEach-Object {
            # Keep full URL, including query string
            $_.AbsoluteUri
        } |
        Sort-Object -Unique

    Write-Host "Found $($urls.Count) static asset URLs in HAR."

    return $urls
}

# -------------------------
# FUNCTION: Pre-warm URLs
# -------------------------
function Invoke-PrewarmUrls {
    param(
        [string[]]$Urls,
        [string]$UserAgent,
        [bool]$UseBasicParsing
    )

    if (-not $Urls -or $Urls.Count -eq 0) {
        Write-Host "No URLs to pre-warm. Exiting."
        return
    }

    Write-Host "Starting pre-warm on $($Urls.Count) static assets..."
    $Headers = @{
        "User-Agent" = $UserAgent
        "Accept"     = "*/*"
    }

    foreach ($Url in $Urls) {
        Write-Host "Warming: $Url"
        try {
            if ($UseBasicParsing) {
                $response = Invoke-WebRequest -Uri $Url -Headers $Headers -Method GET -UseBasicParsing -TimeoutSec 30
            }
            else {
                $response = Invoke-WebRequest -Uri $Url -Headers $Headers -Method GET -TimeoutSec 30
            }
            Write-Host "  Status: $($response.StatusCode)"
        }
        catch {
            Write-Host "  Error warming $Url : $($_.Exception.Message)"
        }
    }

    Write-Host "Pre-warm finished."
}

# -------------------------
# MAIN LOGIC
# -------------------------
$urls = @()

if (Test-Path $OutputFile) {
    Write-Host "URL list '$OutputFile' already exists."
    $choice = Read-Host "Do you want to reuse this list? (Y/N)"

    if ($choice -match '^[Yy]') {
        Write-Host "Reusing existing URL list from $OutputFile"
        $urls = Get-Content $OutputFile
    }
    else {
        Write-Host "Re-extracting URLs from HAR..."
        try {
            $urls = Get-StaticUrlsFromHar -HarFilePath $HarPath -StaticExts $StaticExtensions -ExcludedHosts $ExcludedHosts
        }
        catch {
            Write-Host "ERROR: $($_.Exception.Message)"
            return
        }

        if ($urls.Count -eq 0) {
            Write-Host "No static URLs found — nothing to warm."
            return
        }

        $urls | Set-Content -Encoding UTF8 $OutputFile
        Write-Host "Saved new URL list to $OutputFile"
    }
}
else {
    Write-Host "No existing URL list found. Extracting from HAR..."
    try {
        $urls = Get-StaticUrlsFromHar -HarFilePath $HarPath -StaticExts $StaticExtensions -ExcludedHosts $ExcludedHosts
    }
    catch {
        Write-Host "ERROR: $($_.Exception.Message)"
        return
    }

    if ($urls.Count -eq 0) {
        Write-Host "No static URLs found — nothing to warm."
        return
    }

    $urls | Set-Content -Encoding UTF8 $OutputFile
    Write-Host "Saved new URL list to $OutputFile"
}

# Final safety check & pre-warm
Write-Host "Loaded $($urls.Count) URLs from list. Proceeding to pre-warm..."
Invoke-PrewarmUrls -Urls $urls -UserAgent $UserAgent -UseBasicParsing:$IsWindowsPowerShell5
